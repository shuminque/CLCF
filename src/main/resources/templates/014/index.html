<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../../static/css/index.css">
    <title>数字化分析</title>
<!--    <script src="../../static/js/jquery-2.2.1.min.js"></script>旧版本-->
    <script src="/static/js/http_ajax.googleapis.com_ajax_libs_jquery_3.5.1_jquery.js"></script>
    <script src="../../static/js/rem.js"></script>
    <script src="../../static/js/echarts.min.js"></script>
    <script src="../../static/js/index.js"></script>
</head>
<body>
    <div class="t_container">
        <main class="t_main">
            <header class="t_title">
                <h2>各客户库存概况</h2>
                <div>
                    <input type="date" id="cutoff-date">
                    <select id="depository-select">
                        <option value="ALL">所有厂区</option>
                        <option value="SAB">SAB</option>
                        <option value="ZAB">ZAB</option>
                    </select>
                    <select id="state-select">
                        <option value="ALL">所有状态</option>
                        <option value="正常">正常</option>
                        <option value="死库">死库</option>
                    </select>
                </div>
            </header>
            <div class="t_box">
                <div id="chart_2" style="width: 100%; height: 100%;"></div>
            </div>
        </main>
    </div>
    <script>
        // 添加事件监听器，当日期或厂区改变时，更新图表数据
        document.getElementById('cutoff-date').addEventListener('change', updateChartData);
        document.getElementById('depository-select').addEventListener('change', updateChartData);
        document.getElementById('state-select').addEventListener('change', updateChartData);

        function updateChartData() {
            const selectedDate = document.getElementById('cutoff-date').value;
            const selectedDepository = document.getElementById('depository-select').value;
            const selectedState = document.getElementById('state-select').value;
            if (selectedDate) {
                fetchChartDataAndUpdateEchart(selectedDate, selectedDepository, selectedState);
            }
        }
        function loadInitialChartData() {
            const today = new Date().toISOString().split('T')[0]; // 获取今天的日期，格式为YYYY-MM-DD
            document.getElementById('cutoff-date').value = today; // 设置日期选择器为今天
            updateChartData(); // 使用今天的日期加载图表数据
        }
        // 获取并更新图表数据的函数，根据指定的截止日期
        function fetchChartDataAndUpdateEchart(cutoffDate, depository, state) {
            // 构建请求URL，根据是否选择了“所有厂区”来调整参数
            let url = `/shipment/clstatus?cutoffDate=${cutoffDate}`;
            // if (depository !== 'ALL') {
            //     url += `&depository=${depository}`;
            // }
            // if (state !== 'ALL') {
            //     url += `&state=${state}`;
            // }
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    echart_2(data); // 使用获取的数据更新图表
                })
                .catch(error => console.error('Error fetching chart data:', error));
        }

        function echart_2(chartData) {
            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('chart_2'));
            const customers = [...new Set(chartData.map(item => item.customer))]; // 假设chartData是您的数据
            const colors = customers.map(() => generateRandomColor());
            // 处理从后端获取的数据
            const yAxisData = chartData.map(item => item.customer); // 顾客名称
            const totals = chartData.reduce((acc, item) => {
                acc.weight += item.weight;
                return acc;
            }, { weight: 0});
            const legendData = yAxisData;
            const barSeriesData = chartData.map(item => item.weight ); // 假设后端数据有LA_quantity属性
            const pieSeriesData = chartData.map(item => ({
                value: 1,
                name: item.customer, // 使用name作为饼图的名称
                weight: item.weight, // 在这里添加LB的数量
            }));
            myChart.setOption   ({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '5%',
                    right: '80%',
                    top: '10%',
                    bottom: '10%',
                    containLabel: true,
                },
                series: [
                    {
                        type: 'pie',
                        radius: ['50%', '77%'],
                        center: ['20%', '50%'],
                        roseType: 'radius',
                        color: function(params) {
                            // 这里使用params.dataIndex来获取当前数据项的索引，然后使用该索引从colors数组中获取颜色
                            return colors[params.dataIndex % colors.length]; // 使用模运算确保索引不会超出数组长度
                        },
                        data: pieSeriesData,
                        label: {
                            normal: {
                                rich: {
                                    nameStyle: {
                                        // 名称样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    },
                                    valueStyle: {
                                        // 数值样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    }
                                },
                                formatter: function(param) {
                                    const formatter = new Intl.NumberFormat('en-US');
                                    const weightFormatted = formatter.format(param.data.weight);

                                    return [
                                        '{nameStyle|' + param.name + '}',
                                        '{valueStyle|重量: ' + weightFormatted + '}'
                                    ].join('\n');
                                },
                                padding: [0, 10] // 根据需要调整padding来对齐文本
                            }
                        },
                        labelLine: {
                            normal: {
                                length: 30, // 调整指向线的起始部分长度
                                length2: 15, // 调整指向线从转折点到标签的部分长度
                                smooth: 0.2, // 可以尝试启用平滑
                                lineStyle: {
                                    color: '#FFFFFF' // 设置线条颜色为白色
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                shadowBlur: 30,
                                shadowColor: 'rgba(0, 0, 0, 0.4)'
                            }
                        },
                        animationType: 'scale',
                        animationEasing: 'elasticOut',
                        animationDelay: function(idx) {
                            return Math.random() * 200;
                        }
                    },
                    {
                        type: 'pie',
                        radius: ['50%', '77%'],
                        center: ['80%', '50%'],
                        roseType: 'radius',
                            color: function(params) {
                                // 这里使用params.dataIndex来获取当前数据项的索引，然后使用该索引从colors数组中获取颜色
                                return colors[params.dataIndex % colors.length]; // 使用模运算确保索引不会超出数组长度
                            },
                        data: pieSeriesData,
                        label: {
                            normal: {
                                rich: {
                                    nameStyle: {
                                        // 名称样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    },
                                    valueStyle: {
                                        // 数值样式
                                        color: '#FFFFFF',
                                        align: 'left',
                                        fontSize: 13,
                                        lineHeight: 12
                                    }
                                },
                                formatter: function(param) {
                                    const formatter = new Intl.NumberFormat('en-US');
                                    const weightFormatted = formatter.format(param.data.weight);

                                    return [
                                        '{nameStyle|' + param.name + '}',
                                        '{valueStyle|重量: ' + weightFormatted + '}'
                                    ].join('\n');
                                },
                                padding: [0, 10] // 根据需要调整padding来对齐文本
                            }
                        },
                        // tooltip: {
                            //     trigger: 'item',
                            //     formatter: function(param) {
                            //         return `${param.name}: <br>外轮:${param.data.LA_quantity}<br>内轮:${param.data.LB_quantity}`;
                            //     }
                            // },
                            labelLine: {
                                normal: {
                                    length: 30, // 调整指向线的起始部分长度
                                    length2: 15, // 调整指向线从转折点到标签的部分长度
                                    smooth: 0.2, // 可以尝试启用平滑
                                    lineStyle: {
                                        color: '#FFFFFF' // 设置线条颜色为白色
                                    }
                                }
                            },
                            itemStyle: {
                            normal: {
                                shadowBlur: 30,
                                shadowColor: 'rgba(0, 0, 0, 0.4)'
                            }
                        },
                        animationType: 'scale',
                        animationEasing: 'elasticOut',
                        animationDelay: function(idx) {
                            return Math.random() * 200;
                        }
                    }
                ]
            });

        }

        // 页面加载完成后，自动加载数据
        document.addEventListener('DOMContentLoaded', loadInitialChartData);
        function generateRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>
</html>