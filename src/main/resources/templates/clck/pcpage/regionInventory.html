<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>各大区在库情况</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script type="text/javascript" src="/static/js/http_unpkg.com_html5-qrcode.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery-2.1.0.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/jquery.qrcode.js" charset="utf-8"></script>
    <style>
        body, html {
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            margin-bottom: 20px;
        }
        .pagination {
            justify-content: center;
        }
        #printArea div {
            display: inline-block;
            margin: 0; /* Add space around each QR code */
            padding: 10px; /* Optional: Adds padding around the QR code for better visibility */
            border: 1px solid #ccc; /* Optional: Adds a border around each QR code */
            background-color: #f9f9f9; /* Optional: Sets a background color for each QR code area */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printArea, #printArea * {
                visibility: visible;
            }
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
<section class="section">
    <div class="container">
        <h1 class="title">各大区在库情况</h1>
        <div class="field">
            <select class="input area-select" name="area" id="areaSelect">
                <option value="" selected>选择库位</option>
                <option th:each="placement_area : ${areas}"
                        th:value="${placement_area.area}"
                        th:text="${placement_area.area}"></option>
            </select>
        </div>
        <div class="field">
            <div class="control">
                <input class="input" type="text" id="search" placeholder="搜索...">
            </div>
        </div>
        <table class="table is-striped is-fullwidth">
            <thead>
            <tr>
                <th>发票编号</th>
                <th>客户</th>
                <th>贸易方式</th>
                <th>到货点</th>
                <th>到港日期</th>
                <th>到达日期</th>
                <th>钢材等级</th>
                <th>尺寸</th>
                <th>重量</th>
                <th>钢厂</th>
                <th>炉号</th>
                <th>操作类型</th>
                <th>库位</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="recordsTableBody">
            </tbody>
        </table>
        <nav class="pagination" role="navigation" aria-label="pagination">
            <a class="pagination-previous" id="prevPage">上一页</a>
            <a class="pagination-next" id="nextPage">下一页</a>
            <ul class="pagination-list" id="paginationList">
            </ul>
        </nav>
        <div id="printArea"></div>
    </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/static/js/jquery.qrcode.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentPage = 1;
        const recordsPerPage = 10;

        function fetchRecords(page = 1, query = '', area = '') {
            axios.get('/records')
                .then(response => {
                    const records = response.data;
                    const filteredRecords = records.filter(record =>
                        (area ? record.placementArea && record.placementArea.startsWith(area) : true) &&
                        Object.values(record).some(value =>
                            value && value.toString().toLowerCase().includes(query.toLowerCase())
                        )
                    );
                    displayRecords(filteredRecords, page);
                    setupPagination(filteredRecords.length, page);
                })
                .catch(error => {
                    console.error('Error fetching records:', error);
                });
        }

        function displayRecords(records, page) {
            const startIndex = (page - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const recordsToDisplay = records.slice(startIndex, endIndex);

            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = '';

            recordsToDisplay.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.invoiceNumber || ''}</td>
                    <td>${record.customer || ''}</td>
                    <td>${record.tradeMode || ''}</td>
                    <td>${record.deliveryPoint || ''}</td>
                    <td>${formatDate(record.arrivalPortDate) || ''}</td>
                    <td>${formatDate(record.arrivalDate) || ''}</td>
                    <td>${record.steelGrade || ''}</td>
                    <td>${record.dimensions || ''}</td>
                    <td>${record.weight || ''}</td>
                    <td>${record.steelMill || ''}</td>
                    <td>${record.furnaceNumber || ''}</td>
                    <td>${record.operationType || ''}</td>
                    <td>${record.placementArea || ''}</td>
                    <td><button class="button is-small is-link" onclick="printQRCode(${record.id})">打印二维码</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function setupPagination(totalRecords, page) {
            const totalPages = Math.ceil(totalRecords / recordsPerPage);

            const paginationList = document.getElementById('paginationList');
            paginationList.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                const pageLink = document.createElement('a');
                pageLink.className = 'pagination-link';
                if (i === page) pageLink.classList.add('is-current');
                pageLink.innerText = i;
                pageLink.addEventListener('click', () => fetchRecords(i));
                pageItem.appendChild(pageLink);
                paginationList.appendChild(pageItem);
            }

            document.getElementById('prevPage').disabled = page === 1;
            document.getElementById('nextPage').disabled = page === totalPages;

            document.getElementById('prevPage').addEventListener('click', () => {
                if (page > 1) fetchRecords(page - 1);
            });
            document.getElementById('nextPage').addEventListener('click', () => {
                if (page < totalPages) fetchRecords(page + 1);
            });
        }

        document.getElementById('search').addEventListener('input', (event) => {
            const query = event.target.value;
            const area = document.getElementById('areaSelect').value;
            fetchRecords(1, query, area);
        });

        document.getElementById('areaSelect').addEventListener('change', (event) => {
            const area = event.target.value;
            const query = document.getElementById('search').value;
            fetchRecords(1, query, area);
        });

        fetchRecords();
    });

    function printQRCode(id) {
        console.log(id);
        axios.get(`/records/${id}`)
            .then(response => {
                const record = response.data;
                const printArea = document.getElementById('printArea');
                printArea.innerHTML = '';
                const qrDiv = document.createElement('div');
                $(qrDiv).qrcode({
                    text: Object.values({
                        arrivalDate: record.arrivalDate,
                        steelMill: record.steelMill,
                        steelGrade: record.steelGrade,
                        furnaceNumber: record.furnaceNumber,
                        weight: record.weight,
                        bundleCount: record.bundleCount,
                        purchaser: record.purchaser,
                        tradeMode: record.tradeMode,
                        customer: record.customer,
                        deliveryPoint: record.deliveryPoint,
                        supplierBatchNumber: record.supplierBatchNumber
                    }).join('|'),
                    width: 185,
                    height: 185,
                    correctLevel: 3
                });
                const textDiv = document.createElement('div');
                textDiv.innerHTML = `
                    <strong>日期:</strong> ${formatDate(record.arrivalDate)}<br>
                    <strong>钢厂:</strong> ${record.steelMill}<br>
                    <strong>钢材等级:</strong> ${record.steelGrade}<br>
                    <strong>炉号:</strong> ${record.furnaceNumber}<br>
                    <strong>尺寸:</strong> ${record.dimensions}<br>
                    <strong>重量:</strong> ${record.weight}<span>（kg）</span><br>
                    <strong>购买方:</strong> ${record.purchaser}<br>
                    <strong>贸易方式:</strong> ${record.tradeMode}
                `;
                printArea.appendChild(qrDiv);
                printArea.appendChild(textDiv);
                window.print();
            })
            .catch(error => {
                console.error('Error fetching record:', error);
            });
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        let date = new Date(dateStr);
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
</script>
</body>
</html>
